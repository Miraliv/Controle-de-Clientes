<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apiário Avoante</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            padding: 20px;
        }
        .navbar-custom {
            background-color: #f8d568;
        }
        .table td, .table th {
            vertical-align: middle;
        }
        .btn-isolated {
            margin-left: auto;
        }
        .situacao-bold {
            font-weight: bold;
        }
        .table tbody tr:nth-child(odd) {
            background-color: #f2f2f2;
        }
        .table tbody tr:nth-child(even) {
            background-color: #ffffff;
        }
        .situacao-warning {
            color: #ffc107;
        }
        .situacao-success {
            color: #28a745;
        }
        .situacao-danger {
            color: #dc3545;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-custom">
    <span class="navbar-brand mb-0 h1">Apiário Avoante</span>
</nav>

<!-- Nome colheita -->
<h1 id="harvestNameTitle" class="mt-4"></h1>

<!--  -->
<div class="d-flex justify-content-between align-items-center mt-3">
    <div>
        <button id="addHarvestButton" class="btn btn-primary" data-toggle="modal" data-target="#addHarvestModal">Adicionar Colheita</button>
        <div class="dropdown d-inline-block">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="harvestDropdownButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Selecionar Colheita
            </button>
            <div class="dropdown-menu" aria-labelledby="harvestDropdownButton" id="harvestDropdownMenu">
                <!--  -->
            </div>
        </div>
    </div>
    <div class="d-inline-block">
        <button id="addCustomerButton" class="btn btn-success btn-isolated" disabled data-toggle="modal" data-target="#addCustomerModal">Adicionar Cliente</button>
        <div class="dropdown d-inline-block">
            <button class="btn btn-info dropdown-toggle" type="button" id="filterDropdownButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Filtrar Clientes
            </button>
            <div class="dropdown-menu" aria-labelledby="filterDropdownButton" id="filterDropdownMenu">
                <a class="dropdown-item" href="#" onclick="filterCustomers('Todos')">Todos os clientes</a>
                <a class="dropdown-item" href="#" onclick="filterCustomers('Quer comprar')">Querem comprar</a>
                <a class="dropdown-item" href="#" onclick="filterCustomers('Já pagou')">Já pagaram</a>
                <a class="dropdown-item" href="#" onclick="filterCustomers('Falta pagar')">Faltam pagar</a>
            </div>
        </div>
    </div>
</div>

<!--  -->
<div id="harvestData" class="mt-3"></div>

<!--  -->
<div id="tablesContent" class="mt-4"></div>

<!--  -->
<div class="modal fade" id="addHarvestModal" tabindex="-1" aria-labelledby="addHarvestModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="addHarvestForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addHarvestModalLabel">Adicionar Nova Colheita</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="harvestName">Nome da Colheita</label>
                    <input type="text" class="form-control" id="harvestName" required>
                </div>
                <div class="form-group">
                    <label for="harvestHoneyJars">Total de Garrafas de Mel</label>
                    <input type="number" class="form-control" id="harvestHoneyJars" required>
                </div>
                <div class="form-group">
                    <label for="harvestHoneycombs">Total de Potes de Favo</label>
                    <input type="number" class="form-control" id="harvestHoneycombs" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                <button type="submit" class="btn btn-primary">Salvar Colheita</button>
            </div>
        </form>
    </div>
</div>

<!--  -->
<div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="addCustomerForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCustomerModalLabel">Adicionar Cliente</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="customerName">Nome do Cliente</label>
                    <input type="text" class="form-control" id="customerName" required>
                </div>
                <div class="form-group">
                    <label for="customerPhone">Telefone</label>
                    <input type="text" class="form-control" id="customerPhone" placeholder="(xx) xxxxx-xxxx" required>
                </div>
                <div class="form-group">
                    <label for="customerSituacao">Situação</label>
                    <select class="form-control" id="customerSituacao" required>
                        <option value="Quer comprar">Quer comprar</option>
                        <option value="Já pagou">Já pagou</option>
                        <option value="Falta pagar">Falta pagar</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="customerHoneyJars">Garrafas de Mel</label>
                    <input type="number" class="form-control" id="customerHoneyJars" required>
                </div>
                <div class="form-group">
                    <label for="customerHoneycombs">Potes de Favo</label>
                    <input type="number" class="form-control" id="customerHoneycombs" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                <button type="submit" class="btn btn-success">Adicionar Cliente</button>
            </div>
        </form>
    </div>
</div>

<!--  -->
<div class="modal fade" id="updateCustomerModal" tabindex="-1" aria-labelledby="updateCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="updateCustomerForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateCustomerModalLabel">Atualizar Cliente</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="updateCustomerIndex">
                <div class="form-group">
                    <label for="updateCustomerName">Nome do Cliente</label>
                    <input type="text" class="form-control" id="updateCustomerName" required>
                </div>
                <div class="form-group">
                    <label for="updateCustomerPhone">Telefone</label>
                    <input type="text" class="form-control" id="updateCustomerPhone" placeholder="(xx) xxxxx-xxxx" required>
                </div>
                <div class="form-group">
                    <label for="updateCustomerSituacao">Situação</label>
                    <select class="form-control" id="updateCustomerSituacao" required>
                        <option value="Quer comprar">Quer comprar</option>
                        <option value="Já pagou">Já pagou</option>
                        <option value="Falta pagar">Falta pagar</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="updateCustomerHoneyJars">Garrafas de Mel</label>
                    <input type="number" class="form-control" id="updateCustomerHoneyJars" required>
                </div>
                <div class="form-group">
                    <label for="updateCustomerHoneycombs">Potes de Favo</label>
                    <input type="number" class="form-control" id="updateCustomerHoneycombs" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                <button type="submit" class="btn btn-primary">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Inicialização de variáveis globais
    let colheitas = [];
    let clientes = [];
    let clientesFiltrados = [];

    function loadHarvests() {
        axios.get('/api/colheitas')
            .then(response => {
                colheitas = Array.isArray(response.data) ? response.data : [];
                updateHarvestDropdown();
            })
            .catch(error => {
                console.error('Erro ao carregar colheitas:', error);
            });
    }

    function updateHarvestDropdown() {
        const harvestDropdownMenu = document.getElementById('harvestDropdownMenu');
        harvestDropdownMenu.innerHTML = '';

        colheitas.forEach((colheita, index) => {
            const dropdownItem = document.createElement('a');
            dropdownItem.className = 'dropdown-item';
            dropdownItem.href = '#';
            dropdownItem.textContent = colheita.nome;
            dropdownItem.onclick = () => {
                selectHarvest(colheita);
            };
            harvestDropdownMenu.appendChild(dropdownItem);
        });
    }

    function selectHarvest(colheita) {
        document.getElementById('harvestNameTitle').textContent = colheita.nome;
        document.getElementById('addCustomerButton').disabled = false;

        loadCustomers(colheita.id);

        const harvestData = document.getElementById('harvestData');
        harvestData.innerHTML = `
            <h5>Detalhes da Colheita</h5>
            <p>Garrafas de Mel: ${colheita.totalGarrafasMel}</p>
            <p>Potes de Favo: ${colheita.totalPotesFavo}</p>
        `;
    }

    function loadCustomers(harvestId) {
        axios.get(`/api/colheitas/${harvestId}/clientes`)
            .then(response => {
                clientes = Array.isArray(response.data) ? response.data : [];
                clientesFiltrados = clientes; // Inicialmente, todos os clientes são exibidos
                updateCustomerTable();
            })
            .catch(error => {
                console.error('Erro ao carregar clientes:', error);
            });
    }

    function filterCustomers(situacao) {
        if (situacao === 'Todos') {
            clientesFiltrados = clientes;
        } else {
            clientesFiltrados = clientes.filter(cliente => cliente.situacao === situacao);
        }
        updateCustomerTable();
    }

    function updateCustomerTable() {
        const tablesContent = document.getElementById('tablesContent');
        tablesContent.innerHTML = '';

        if (clientesFiltrados.length === 0) {
            tablesContent.innerHTML = '<p>Nenhum cliente encontrado.</p>';
            return;
        }

        const table = document.createElement('table');
        table.className = 'table table-striped';

        const thead = document.createElement('thead');
        thead.innerHTML = `
            <tr>
                <th>Nome</th>
                <th>Telefone</th>
                <th>Situação</th>
                <th>Garrafas de Mel</th>
                <th>Potes de Favo</th>
                <th>Ações</th>
            </tr>
        `;

        const tbody = document.createElement('tbody');
        clientesFiltrados.forEach((cliente, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${cliente.nome}</td>
                <td>${cliente.telefone}</td>
                <td class="${getSituacaoClass(cliente.situacao)}">${cliente.situacao}</td>
                <td>${cliente.garrafasMel}</td>
                <td>${cliente.potesFavo}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editCustomer(${index})">Editar</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${cliente.id})">Excluir</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        tablesContent.appendChild(table);
    }

    function getSituacaoClass(situacao) {
        switch (situacao) {
            case 'Quer comprar':
                return 'situacao-warning';
            case 'Já pagou':
                return 'situacao-success';
            case 'Falta pagar':
                return 'situacao-danger';
            default:
                return '';
        }
    }

    function addHarvest(event) {
        event.preventDefault();

        const nome = document.getElementById('harvestName').value;
        const totalGarrafasMel = parseInt(document.getElementById('harvestHoneyJars').value);
        const totalPotesFavo = parseInt(document.getElementById('harvestHoneycombs').value);

        axios.post('/api/colheitas', { nome, totalGarrafasMel, totalPotesFavo })
            .then(response => {
                colheitas.push(response.data);
                updateHarvestDropdown();
                document.getElementById('addHarvestForm').reset();
                $('#addHarvestModal').modal('hide');
            })
            .catch(error => {
                console.error('Erro ao adicionar colheita:', error);
            });
    }

    function addCustomer(event) {
        event.preventDefault();

        const nome = document.getElementById('customerName').value;
        const telefone = document.getElementById('customerPhone').value;
        const situacao = document.getElementById('customerSituacao').value;
        const garrafasMel = parseInt(document.getElementById('customerHoneyJars').value);
        const potesFavo = parseInt(document.getElementById('customerHoneycombs').value);

        const selectedHarvest = colheitas.find(colheita => colheita.nome === document.getElementById('harvestNameTitle').textContent);

        if (!selectedHarvest) {
            alert('Selecione uma colheita para adicionar um cliente.');
            return;
        }

        axios.post('/api/clientes', { nome, telefone, situacao, garrafasMel, potesFavo, colheita: { id: selectedHarvest.id } })
            .then(response => {
                clientes.push(response.data);
                clientesFiltrados = clientes;
                updateCustomerTable();
                document.getElementById('addCustomerForm').reset();
                $('#addCustomerModal').modal('hide');
            })
            .catch(error => {
                console.error('Erro ao adicionar cliente:', error);
            });
    }

    function editCustomer(index) {
        const cliente = clientesFiltrados[index];
        document.getElementById('updateCustomerIndex').value = index;
        document.getElementById('updateCustomerName').value = cliente.nome;
        document.getElementById('updateCustomerPhone').value = cliente.telefone;
        document.getElementById('updateCustomerSituacao').value = cliente.situacao;
        document.getElementById('updateCustomerHoneyJars').value = cliente.garrafasMel;
        document.getElementById('updateCustomerHoneycombs').value = cliente.potesFavo;
        $('#updateCustomerModal').modal('show');
    }

    function updateCustomer(event) {
        event.preventDefault();

        const index = document.getElementById('updateCustomerIndex').value;
        const nome = document.getElementById('updateCustomerName').value;
        const telefone = document.getElementById('updateCustomerPhone').value;
        const situacao = document.getElementById('updateCustomerSituacao').value;
        const garrafasMel = parseInt(document.getElementById('updateCustomerHoneyJars').value);
        const potesFavo = parseInt(document.getElementById('updateCustomerHoneycombs').value);

        const cliente = clientesFiltrados[index];
        cliente.nome = nome;
        cliente.telefone = telefone;
        cliente.situacao = situacao;
        cliente.garrafasMel = garrafasMel;
        cliente.potesFavo = potesFavo;

        axios.put(`/api/clientes/${cliente.id}`, cliente)
            .then(response => {
                clientesFiltrados[index] = response.data;
                updateCustomerTable();
                $('#updateCustomerModal').modal('hide');
            })
            .catch(error => {
                console.error('Erro ao atualizar cliente:', error);
            });
    }

    function deleteCustomer(id) {
        axios.delete(`/api/clientes/${id}`)
            .then(() => {
                clientes = clientes.filter(cliente => cliente.id !== id);
                clientesFiltrados = clientesFiltrados.filter(cliente => cliente.id !== id);
                updateCustomerTable();
            })
            .catch(error => {
                console.error('Erro ao excluir cliente:', error);
            });
    }

    // Event Listeners
    document.getElementById('addHarvestForm').addEventListener('submit', addHarvest);
    document.getElementById('addCustomerForm').addEventListener('submit', addCustomer);
    document.getElementById('updateCustomerForm').addEventListener('submit', updateCustomer);

    // Load initial data
    loadHarvests();

</script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
